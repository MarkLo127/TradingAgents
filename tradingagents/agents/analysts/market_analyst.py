from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import time
import json
from tradingagents.agents.utils.agent_utils import get_stock_data, get_indicators
from tradingagents.dataflows.config import get_config


def create_market_analyst(llm):
    """
    å»ºç«‹ä¸€å€‹å¸‚å ´åˆ†æå¸«ç¯€é»ã€‚

    Args:
        llm: ç”¨æ–¼åˆ†æçš„èªè¨€æ¨¡å‹ã€‚

    Returns:
        ä¸€å€‹è™•ç†å¸‚å ´åˆ†æçš„ç¯€é»å‡½å¼ã€‚
    """

    def market_analyst_node(state):
        """
        åˆ†æå¸‚å ´æ•¸æ“šå’ŒæŠ€è¡“æŒ‡æ¨™ã€‚

        Args:
            state: ç•¶å‰çš„ä»£ç†ç‹€æ…‹ã€‚

        Returns:
            æ›´æ–°å¾Œçš„ä»£ç†ç‹€æ…‹ï¼ŒåŒ…å«å¸‚å ´åˆ†æå ±å‘Šå’Œè¨Šæ¯ã€‚
        """
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]
        company_name = state.get("company_name", ticker)  # ä½¿ç”¨çœŸå¯¦å…¬å¸åç¨±ï¼Œfallbackåˆ°ticker

        tools = [
            get_stock_data,
            get_indicators,
        ]

        system_message = (
            """**é‡è¦ï¼šæ‚¨å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆTraditional Chineseï¼‰å›è¦†æ‰€æœ‰å…§å®¹ã€‚**

ã€å°ˆæ¥­èº«ä»½ã€‘
æ‚¨æ˜¯è³‡æ·±æŠ€è¡“åˆ†æå¸«ï¼Œè² è²¬æä¾›ç²¾æº–çš„å¸‚å ´æŠ€è¡“é¢è©•ä¼°ã€‚

ã€åˆ†æé‡é»ã€‘
1. **è¶¨å‹¢ç ”åˆ¤**ï¼šåŸºæ–¼åƒ¹æ ¼èµ°å‹¢èˆ‡æˆäº¤é‡ï¼Œæ˜ç¢ºåˆ¤æ–·ç•¶å‰å¸‚å ´éšæ®µï¼ˆä¸Šå‡è¶¨å‹¢/ä¸‹é™è¶¨å‹¢/å€é–“æ•´ç†ï¼‰
2. **æŠ€è¡“æŒ‡æ¨™**ï¼šèšç„¦3-4å€‹æ ¸å¿ƒæŒ‡æ¨™ï¼ˆå»ºè­°ï¼š50æ—¥/200æ—¥å‡ç·šã€MACDã€RSIï¼‰ï¼Œè§£è®€å…¶è¨Šè™Ÿæ„ç¾©
3. **æ”¯æ’å£“åŠ›**ï¼šæ¨™ç¤ºé—œéµåƒ¹æ ¼å€é–“ï¼Œèªªæ˜æŠ€è¡“é¢è½‰æŠ˜é»
4. **æ“ä½œå»ºè­°**ï¼šæä¾›é€²å‡ºå ´ä½ç½®ã€é¢¨éšªæ§åˆ¶åƒæ•¸

ã€æŠ€è¡“æ“ä½œã€‘
â€¢ ä½¿ç”¨ get_stock_data å–å¾—æ­·å²åƒ¹æ ¼è³‡æ–™
â€¢ ä½¿ç”¨ get_indicators è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆå‡ç·šè«‹è¨­å®š look_back_days ç‚º 50 æˆ– 200ï¼‰
â€¢ æ•´åˆæ•¸æ“šå¾Œæå‡ºå°ˆæ¥­è¦‹è§£

ã€å ±å‘Šæ¶æ§‹ã€‘
**å­—æ•¸è¦æ±‚**ï¼š**è‡³å°‘800å­—ä»¥ä¸Šï¼ˆä¸å«è¡¨æ ¼ï¼‰**
**å…§å®¹çµæ§‹**ï¼š
1. å¸‚å ´æ¦‚æ³ï¼ˆ150å­—ä»¥ä¸Šï¼‰ï¼šè¶¨å‹¢æ–¹å‘èˆ‡å‹•èƒ½å¼·å¼±
2. æŠ€è¡“åˆ†æï¼ˆ400-450å­—ï¼‰ï¼šæŒ‡æ¨™è§£è®€èˆ‡ç›¸äº’é©—è­‰
3. é—œéµåƒ¹ä½ï¼ˆ100å­—ä»¥ä¸Šï¼‰ï¼šæ”¯æ’/å£“åŠ›ä½åŠå…¶æŠ€è¡“æ„ç¾©
4. æ“ä½œç­–ç•¥ï¼ˆ150å­—ä»¥ä¸Šï¼‰ï¼šé€²å ´é»ä½ã€åœæè¨­å®šã€ç›®æ¨™åƒ¹ä½
5. æ•¸æ“šæ‘˜è¦è¡¨æ ¼ï¼ˆå¿…é ˆï¼‰

**æ’°å¯«åŸå‰‡**ï¼š
- å°ˆæ¥­ä½†æ¸…æ™°ï¼Œé¿å…éåº¦æŠ€è¡“åŒ–çš„è¡¨è¿°
- çµè«–æ˜ç¢ºï¼Œæä¾›å¯åŸ·è¡Œçš„äº¤æ˜“å»ºè­°
- å¿…é ˆåŒ…å«æ ¸å¿ƒæ•¸æ“šæ•´ç†è¡¨æ ¼

**çµå°¾æç¤º**ï¼š
è«‹åœ¨å ±å‘Šæœ€å¾ŒåŠ ä¸Šä»¥ä¸‹çµå°¾ï¼š
ã€Œ---
ğŸ“Š **æœ¬å ±å‘Šç‚ºæŠ€è¡“é¢åˆ†æï¼Œå»ºè­°æ­é…åŸºæœ¬é¢åŠå¸‚å ´æƒ…ç·’ç¶œåˆç ”åˆ¤ã€‚æŠ€è¡“æŒ‡æ¨™å…·æ»¯å¾Œæ€§ï¼ŒæŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…è©•ä¼°ã€‚**ã€

è«‹æä¾›å°ˆæ¥­ã€ç²¾æº–ä¸”å…·æ“ä½œæ€§çš„æŠ€è¡“åˆ†æå ±å‘Šã€‚"""
            + """ è«‹å‹™å¿…åœ¨å ±å‘Šçµå°¾é™„åŠ ä¸€å€‹ Markdown è¡¨æ ¼ï¼Œä»¥æ•´ç†å ±å‘Šä¸­çš„è¦é»ã€‚"""
        )

        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "æ‚¨æ˜¯ä¸€å€‹æ¨‚æ–¼åŠ©äººçš„äººå·¥æ™ºæ…§åŠ©ç†ï¼Œèˆ‡å…¶ä»–åŠ©ç†å”åŒå·¥ä½œã€‚"
                    " ä½¿ç”¨æä¾›çš„å·¥å…·ä¾†é€æ­¥å›ç­”å•é¡Œã€‚"
                    " å¦‚æœæ‚¨ç„¡æ³•å®Œå…¨å›ç­”ï¼Œæ²’é—œä¿‚ï¼›å¦ä¸€å€‹æ“æœ‰ä¸åŒå·¥å…·çš„åŠ©ç†æœƒåœ¨æ‚¨ä¸­æ–·çš„åœ°æ–¹æä¾›å¹«åŠ©ã€‚ç›¡æ‚¨æ‰€èƒ½å–å¾—é€²å±•ã€‚"
                    " å¦‚æœæ‚¨æˆ–ä»»ä½•å…¶ä»–åŠ©ç†æœ‰æœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º** æˆ–å¯äº¤ä»˜æˆæœï¼Œ"
                    " è«‹åœ¨æ‚¨çš„å›è¦†å‰åŠ ä¸Šã€Œæœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º**ã€ï¼Œä»¥ä¾¿åœ˜éšŠçŸ¥é“åœæ­¢ã€‚"
                    " æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
                    "ä¾›æ‚¨åƒè€ƒï¼Œç›®å‰æ—¥æœŸæ˜¯ {current_date}ã€‚æˆ‘å€‘æƒ³é—œæ³¨çš„å…¬å¸æ˜¯ {company_name} ï¼ˆè‚¡ç¥¨ä»£ç¢¼ï¼š{ticker}ï¼‰",
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )

        prompt = prompt.partial(system_message=system_message)
        prompt = prompt.partial(tool_names=", ".join([tool.name for tool in tools]))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)
        prompt = prompt.partial(company_name=company_name)

        chain = prompt | llm.bind_tools(tools)

        result = chain.invoke(state["messages"])

        # å ±å‘Šé‚è¼¯ä¿®å¾©ï¼šåªåœ¨LLMæœ€çµ‚å›æ‡‰æ™‚ä¿å­˜å ±å‘Š
        # ç•¶LLMèª¿ç”¨å·¥å…·æ™‚ï¼ˆtool_callsä¸ç‚ºç©ºï¼‰ï¼Œä¸æ›´æ–°å ±å‘Š
        # ç•¶LLMè¿”å›æœ€çµ‚åˆ†ææ™‚ï¼ˆtool_callsç‚ºç©ºï¼‰ï¼Œä¿å­˜å®Œæ•´å ±å‘Š
        report = state.get("market_report", "")  # ä¿æŒç¾æœ‰å ±å‘Š
        
        if len(result.tool_calls) == 0:
            # æ²’æœ‰å·¥å…·èª¿ç”¨ï¼Œé€™æ˜¯æœ€çµ‚çš„åˆ†æå ±å‘Š
            report = result.content
       
        return {
            "messages": [result],
            "market_report": report,
        }

    return market_analyst_node