from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import time
import json
from tradingagents.agents.utils.agent_utils import get_news, get_global_news
from tradingagents.dataflows.config import get_config


def create_news_analyst(llm):
    """
    å»ºç«‹ä¸€å€‹æ–°èåˆ†æå¸«ç¯€é»ã€‚

    Args:
        llm: ç”¨æ–¼åˆ†æçš„èªè¨€æ¨¡å‹ã€‚

    Returns:
        ä¸€å€‹è™•ç†æ–°èåˆ†æçš„ç¯€é»å‡½å¼ã€‚
    """
    def news_analyst_node(state):
        """
        åˆ†ææœ€è¿‘çš„æ–°èå’Œè¶¨å‹¢ã€‚

        Args:
            state: ç•¶å‰çš„ä»£ç†ç‹€æ…‹ã€‚

        Returns:
            æ›´æ–°å¾Œçš„ä»£ç†ç‹€æ…‹ï¼ŒåŒ…å«æ–°èåˆ†æå ±å‘Šå’Œè¨Šæ¯ã€‚
        """
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]

        tools = [
            get_news,
            get_global_news,
        ]

        system_message = (
            """**é‡è¦ï¼šæ‚¨å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆTraditional Chineseï¼‰å›è¦†æ‰€æœ‰å…§å®¹ã€‚**

ã€å°ˆæ¥­èº«ä»½ã€‘
æ‚¨æ˜¯è²¡ç¶“æ–°èåˆ†æå¸«ï¼Œè² è²¬è§£è®€é‡å¤§äº‹ä»¶å°è‚¡åƒ¹çš„å½±éŸ¿ï¼Œä¸¦æä¾›æŠ•è³‡æ±ºç­–åƒè€ƒã€‚

ã€åˆ†æé‡é»ã€‘
1. **é—œéµäº‹ä»¶**ï¼šç¯©é¸å‡ºè¿‘æœŸæœ€å…·å½±éŸ¿åŠ›çš„2-3å‰‡é‡å¤§æ–°è
2. **å½±éŸ¿è©•ä¼°**ï¼šåˆ†æäº‹ä»¶å°å…¬å¸åŸºæœ¬é¢ã€è‚¡åƒ¹åŠæŠ•è³‡äººæƒ…ç·’çš„å¯¦è³ªå½±éŸ¿
3. **é¢¨éšªè­˜åˆ¥**ï¼šæŒ‡å‡ºæ–°èèƒŒå¾Œçš„æ½›åœ¨é¢¨éšªæˆ–æœªè¢«å¸‚å ´å……åˆ†åæ‡‰çš„å› ç´ 
4. **æŠ•è³‡å•Ÿç¤º**ï¼šæä¾›åŸºæ–¼æ–°èäº‹ä»¶çš„æ“ä½œå»ºè­°

ã€æŠ€è¡“æ“ä½œã€‘
â€¢ ä½¿ç”¨ get_news ç²å–ç›¸é—œæ–°èè³‡æ–™
â€¢ ç¯©é¸é«˜åƒ¹å€¼è³‡è¨Šä¸¦é€²è¡Œæ·±åº¦è§£è®€

ã€å ±å‘Šæ¶æ§‹ã€‘
**å­—æ•¸è¦æ±‚**ï¼š**800-1500å­—ï¼ˆä¸å«è¡¨æ ¼ï¼‰**
**åš´æ ¼éµå®ˆå­—æ•¸é™åˆ¶ï¼Œå°‘æ–¼800å­—æˆ–è¶…é1500å­—çš„å ±å‘Šå°‡è¢«é€€å›**

**å…§å®¹çµæ§‹**ï¼š
1. æ–°èæ‘˜è¦ï¼ˆ120-150å­—ï¼‰ï¼šé‡é»äº‹ä»¶æ¦‚è¿°
2. å½±éŸ¿åˆ†æï¼ˆ400-600å­—ï¼‰ï¼šäº‹ä»¶å°è‚¡åƒ¹çš„å¤šç¶­åº¦å½±éŸ¿è©•ä¼°
3. é¢¨éšªæç¤ºï¼ˆ80-120å­—ï¼‰ï¼šæ½›åœ¨é¢¨éšªæˆ–å¸‚å ´æœªæ³¨æ„çš„å› ç´ 
4. æ“ä½œå»ºè­°ï¼ˆ150-200å­—ï¼‰ï¼šåŸºæ–¼æ–°èé¢çš„æŠ•è³‡ç­–ç•¥
5. æ–°èäº‹ä»¶è¡¨æ ¼ï¼ˆå¿…é ˆï¼Œä¸è¨ˆå…¥å­—æ•¸ï¼‰

**æ’°å¯«åŸå‰‡**ï¼š
- èšç„¦å¯¦è³ªå½±éŸ¿ï¼Œéæ¿¾éé‡è¦è³‡è¨Š
- æä¾›ç¨ç«‹è§€é»èˆ‡å°ˆæ¥­è§£è®€
- å¿…é ˆåŒ…å«é—œéµæ–°èæ•´ç†è¡¨æ ¼
- æ§åˆ¶ç¯‡å¹…ï¼Œç¢ºä¿åœ¨1500å­—ä»¥å…§å®Œæˆåˆ†æ

**çµå°¾æç¤º**ï¼š
è«‹åœ¨å ±å‘Šæœ€å¾ŒåŠ ä¸Šä»¥ä¸‹çµå°¾ï¼š
ã€Œ---
ğŸ“° **æœ¬å ±å‘Šç‚ºæ–°èé¢åˆ†æï¼Œå»ºè­°æ­é…åŸºæœ¬é¢åŠæŠ€è¡“é¢ç¶œåˆç ”åˆ¤ã€‚æ–°èè³‡è¨Šæ™‚æ•ˆæ€§å¼·ï¼ŒæŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…è©•ä¼°ã€‚**ã€

è«‹æä¾›å°ˆæ¥­ä¸”å…·æ´å¯ŸåŠ›çš„æ–°èåˆ†æå ±å‘Šã€‚"""
            + """ è«‹å‹™å¿…åœ¨å ±å‘Šçµå°¾é™„åŠ ä¸€å€‹ Markdown è¡¨æ ¼ï¼Œä»¥æ•´ç†å ±å‘Šä¸­çš„è¦é»ã€‚""",
        )

        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "æ‚¨æ˜¯ä¸€å€‹æ¨‚æ–¼åŠ©äººçš„äººå·¥æ™ºæ…§åŠ©ç†ï¼Œèˆ‡å…¶ä»–åŠ©ç†å”åŒå·¥ä½œã€‚"
                    " ä½¿ç”¨æä¾›çš„å·¥å…·ä¾†é€æ­¥å›ç­”å•é¡Œã€‚"
                    " å¦‚æœæ‚¨ç„¡æ³•å®Œå…¨å›ç­”ï¼Œæ²’é—œä¿‚ï¼›å¦ä¸€å€‹æ“æœ‰ä¸åŒå·¥å…·çš„åŠ©ç†æœƒåœ¨æ‚¨ä¸­æ–·çš„åœ°æ–¹æä¾›å¹«åŠ©ã€‚ç›¡æ‚¨æ‰€èƒ½å–å¾—é€²å±•ã€‚"
                    " å¦‚æœæ‚¨æˆ–ä»»ä½•å…¶ä»–åŠ©ç†æœ‰æœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º** æˆ–å¯äº¤ä»˜æˆæœï¼Œ"
                    " è«‹åœ¨æ‚¨çš„å›è¦†å‰åŠ ä¸Šã€Œæœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º**ã€ï¼Œä»¥ä¾¿åœ˜éšŠçŸ¥é“åœæ­¢ã€‚"
                    " æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
                    "ä¾›æ‚¨åƒè€ƒï¼Œç›®å‰æ—¥æœŸæ˜¯ {current_date}ã€‚æˆ‘å€‘æ­£åœ¨é—œæ³¨çš„å…¬å¸æ˜¯ {company_name} ï¼ˆè‚¡ç¥¨ä»£ç¢¼ï¼š{ticker}ï¼‰",
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )

        prompt = prompt.partial(system_message=system_message)
        prompt = prompt.partial(tool_names=", ".join([tool.name for tool in tools]))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)
        prompt = prompt.partial(company_name=state.get("company_name", ticker))

        chain = prompt | llm.bind_tools(tools)
        result = chain.invoke(state["messages"])

        # å ±å‘Šé‚è¼¯ä¿®å¾©ï¼šåªåœ¨LLMæœ€çµ‚å›æ‡‰æ™‚ä¿å­˜å ±å‘Š
        report = state.get("news_report", "")  # ä¿æŒç¾æœ‰å ±å‘Š

        if len(result.tool_calls) == 0:
            # æ²’æœ‰å·¥å…·èª¿ç”¨ï¼Œé€™æ˜¯æœ€çµ‚çš„åˆ†æå ±å‘Š
            report = result.content

        return {
            "messages": [result],
            "news_report": report,
        }

    return news_analyst_node