from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import time
import json
from tradingagents.agents.utils.agent_utils import get_news
from tradingagents.dataflows.config import get_config


def create_social_media_analyst(llm):
    """
    å»ºç«‹ä¸€å€‹ç¤¾ç¾¤åª’é«”åˆ†æå¸«ç¯€é»ã€‚

    Args:
        llm: ç”¨æ–¼åˆ†æçš„èªè¨€æ¨¡å‹ã€‚

    Returns:
        ä¸€å€‹è™•ç†ç¤¾ç¾¤åª’é«”åˆ†æçš„ç¯€é»å‡½å¼ã€‚
    """
    def social_media_analyst_node(state):
        """
        åˆ†æç¤¾ç¾¤åª’é«”è²¼æ–‡ã€è¿‘æœŸå…¬å¸æ–°èå’Œå…¬çœ¾æƒ…ç·’ã€‚

        Args:
            state: ç•¶å‰çš„ä»£ç†ç‹€æ…‹ã€‚

        Returns:
            æ›´æ–°å¾Œçš„ä»£ç†ç‹€æ…‹ï¼ŒåŒ…å«æƒ…ç·’åˆ†æå ±å‘Šå’Œè¨Šæ¯ã€‚
        """
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]
        company_name = state.get("company_name", ticker)  # ä½¿ç”¨çœŸå¯¦å…¬å¸åç¨±ï¼Œfallbackåˆ°ticker

        tools = [
            get_news,
        ]

        system_message = (
            """**é‡è¦ï¼šæ‚¨å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆTraditional Chineseï¼‰å›è¦†æ‰€æœ‰å…§å®¹ã€‚**

ã€å°ˆæ¥­èº«ä»½ã€‘
æ‚¨æ˜¯å¸‚å ´æƒ…ç·’åˆ†æå°ˆå®¶ï¼Œè² è²¬è§£è®€ç¤¾ç¾¤åª’é«”èˆ‡è¼¿è«–æ°›åœå°è‚¡åƒ¹çš„æ½›åœ¨å½±éŸ¿ã€‚

ã€åˆ†æé‡é»ã€‘
1. **æƒ…ç·’åŸºèª¿**ï¼šè©•ä¼°ç•¶å‰å¸‚å ´æƒ…ç·’ç‹€æ…‹ï¼ˆæ¨‚è§€/ä¸­æ€§/æ‚²è§€ï¼‰åŠå…¶å¼·åº¦
2. **è¨è«–ç†±åº¦**ï¼šè­˜åˆ¥ä¸»æµè©±é¡Œèˆ‡é—œæ³¨ç„¦é»ï¼Œåˆ¤æ–·è¼¿è«–æ–¹å‘
3. **æŠ•è³‡äººçµæ§‹**ï¼šè§€å¯Ÿæ•£æˆ¶èˆ‡æ©Ÿæ§‹è§€é»çš„åˆ†æ­§æˆ–å…±è­˜
4. **æ¥µç«¯è¨Šè™Ÿ**ï¼šæª¢è¦–æ˜¯å¦å‡ºç¾éç†æ€§æ¨‚è§€æˆ–ææ…Œæƒ…ç·’

ã€æŠ€è¡“æ“ä½œã€‘
â€¢ ä½¿ç”¨ get_news ç²å–ç›¸é—œæ–°èèˆ‡ç¤¾ç¾¤è¨è«–è³‡æ–™
â€¢ åˆ†æè¼¿æƒ…å‚¾å‘èˆ‡è¨è«–ç†±åº¦

ã€å ±å‘Šæ¶æ§‹ã€‘
**å­—æ•¸è¦æ±‚**ï¼š**è‡³å°‘800å­—ä»¥ä¸Šï¼ˆä¸å«è¡¨æ ¼ï¼‰**
**å…§å®¹çµæ§‹**ï¼š
1. æƒ…ç·’æ¦‚è¦ï¼ˆ150å­—ä»¥ä¸Šï¼‰ï¼šå¸‚å ´æ°›åœèˆ‡æƒ…ç·’æŒ‡æ¨™
2. è¼¿æƒ…åˆ†æï¼ˆ400-450å­—ï¼‰ï¼šä¸»è¦è¨è«–è­°é¡Œèˆ‡è§€é»åˆ†å¸ƒ
3. é—œéµæ´å¯Ÿï¼ˆ100å­—ä»¥ä¸Šï¼‰ï¼šæƒ…ç·’æ¥µå€¼æˆ–è½‰æŠ˜è¨Šè™Ÿ
4. æŠ•è³‡å«ç¾©ï¼ˆ150å­—ä»¥ä¸Šï¼‰ï¼šæƒ…ç·’é¢å°æ“ä½œç­–ç•¥çš„å•Ÿç¤º
5. æƒ…ç·’æ•¸æ“šè¡¨æ ¼ï¼ˆå¿…é ˆï¼‰

**æ’°å¯«åŸå‰‡**ï¼š
- **å…¼å…·å°ˆæ¥­èˆ‡æ˜“æ‡‚**ï¼šä½¿ç”¨å°ˆæ¥­è¡“èªçš„åŒæ™‚ï¼Œè«‹ç”¨ç”Ÿæ´»åŒ–çš„èªè¨€è®“ä¸€èˆ¬æŠ•è³‡äººä¹Ÿèƒ½ç†è§£
- **èˆ‰ä¾‹èªªæ˜**ï¼šåœ¨è§£è®€æƒ…ç·’æŒ‡æ¨™æ™‚ï¼Œé©æ™‚åŠ å…¥ç™½è©±æ–‡èªªæ˜ï¼ˆä¾‹å¦‚ï¼šã€Œææ…Œè²ªå©ªæŒ‡æ•¸é”78ï¼Œå°±åƒæº«åº¦è¨ˆé¡¯ç¤ºç™¼ç‡’ï¼Œä»£è¡¨å¸‚å ´éç†±éœ€è¦é™æº«ã€ï¼‰
- å®¢è§€åˆ†æï¼Œé¿å…ä¸»è§€è‡†æ¸¬
- èšç„¦æœ‰åƒ¹å€¼çš„æƒ…ç·’è¨Šè™Ÿ
- å¿…é ˆåŒ…å«æƒ…ç·’é‡åŒ–æ•¸æ“šè¡¨æ ¼

**çµå°¾æç¤º**ï¼š
è«‹åœ¨å ±å‘Šæœ€å¾ŒåŠ ä¸Šä»¥ä¸‹çµå°¾ï¼š
ã€Œ---
ğŸ’¬ **æœ¬å ±å‘Šç‚ºå¸‚å ´æƒ…ç·’åˆ†æï¼Œå»ºè­°æ­é…åŸºæœ¬é¢åŠæŠ€è¡“é¢ç¶œåˆç ”åˆ¤ã€‚æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…è©•ä¼°ã€‚**ã€

è«‹æä¾›å°ˆæ¥­ä¸”å…·æ´å¯ŸåŠ›ã€å…¼å…·æ˜“è®€æ€§çš„å¸‚å ´æƒ…ç·’åˆ†æå ±å‘Šã€‚"""
            + """ è«‹å‹™å¿…åœ¨å ±å‘Šçµå°¾é™„åŠ ä¸€å€‹ Markdown è¡¨æ ¼ï¼Œä»¥æ•´ç†å ±å‘Šä¸­çš„è¦é»ã€‚""",
        )

        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "æ‚¨æ˜¯ä¸€å€‹æ¨‚æ–¼åŠ©äººçš„äººå·¥æ™ºæ…§åŠ©ç†ï¼Œèˆ‡å…¶ä»–åŠ©ç†å”åŒå·¥ä½œã€‚"
                    " ä½¿ç”¨æä¾›çš„å·¥å…·ä¾†é€æ­¥å›ç­”å•é¡Œã€‚"
                    " å¦‚æœæ‚¨ç„¡æ³•å®Œå…¨å›ç­”ï¼Œæ²’é—œä¿‚ï¼›å¦ä¸€å€‹æ“æœ‰ä¸åŒå·¥å…·çš„åŠ©ç†æœƒåœ¨æ‚¨ä¸­æ–·çš„åœ°æ–¹æä¾›å¹«åŠ©ã€‚ç›¡æ‚¨æ‰€èƒ½å–å¾—é€²å±•ã€‚"
                    " å¦‚æœæ‚¨æˆ–ä»»ä½•å…¶ä»–åŠ©ç†æœ‰æœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º** æˆ–å¯äº¤ä»˜æˆæœï¼Œ"
                    " è«‹åœ¨æ‚¨çš„å›è¦†å‰åŠ ä¸Šã€Œæœ€çµ‚äº¤æ˜“ææ¡ˆï¼š**è²·å…¥/æŒæœ‰/è³£å‡º**ã€ï¼Œä»¥ä¾¿åœ˜éšŠçŸ¥é“åœæ­¢ã€‚"
                    " æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
                    "ä¾›æ‚¨åƒè€ƒï¼Œç›®å‰æ—¥æœŸæ˜¯ {current_date}ã€‚æˆ‘å€‘ç›®å‰è¦åˆ†æçš„å…¬å¸æ˜¯ {company_name} ï¼ˆè‚¡ç¥¨ä»£ç¢¼ï¼š{ticker}ï¼‰",
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )

        prompt = prompt.partial(system_message=system_message)
        prompt = prompt.partial(tool_names=", ".join([tool.name for tool in tools]))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)
        prompt = prompt.partial(company_name=company_name)

        chain = prompt | llm.bind_tools(tools)

        result = chain.invoke(state["messages"])

        # å ±å‘Šé‚è¼¯ä¿®å¾©ï¼šåªåœ¨LLMæœ€çµ‚å›æ‡‰æ™‚ä¿å­˜å ±å‘Š
        report = state.get("sentiment_report", "")  # ä¿æŒç¾æœ‰å ±å‘Š

        if len(result.tool_calls) == 0:
            # æ²’æœ‰å·¥å…·èª¿ç”¨ï¼Œé€™æ˜¯æœ€çµ‚çš„åˆ†æå ±å‘Š
            report = result.content

        return {
            "messages": [result],
            "sentiment_report": report,
        }

    return social_media_analyst_node