# -*- coding: utf-8 -*-
from langchain_core.messages import AIMessage
import time
import json


def create_safe_debator(llm):
    """
    å»ºç«‹ä¸€å€‹å®‰å…¨/ä¿å®ˆçš„é¢¨éšªè¾¯è«–å“¡ç¯€é»ã€‚

    é€™å€‹ç¯€é»åœ¨é¢¨éšªè©•ä¼°è¾¯è«–ä¸­æ‰®æ¼”ä¿å®ˆæ´¾çš„è§’è‰²ã€‚
    å…¶ä¸»è¦ç›®æ¨™æ˜¯ä¿è­·è³‡ç”¢ã€æœ€å°åŒ–æ³¢å‹•æ€§ä¸¦ç¢ºä¿ç©©å®šå¯é çš„å¢é•·ã€‚
    å®ƒæœƒå„ªå…ˆè€ƒæ…®ç©©å®šæ€§ã€å®‰å…¨æ€§å’Œé¢¨éšªç·©è§£ï¼Œä¸¦å°äº¤æ˜“å“¡çš„æ±ºç­–æå‡ºè¬¹æ…çš„èª¿æ•´å»ºè­°ã€‚

    Args:
        llm: ç”¨æ–¼ç”Ÿæˆå›æ‡‰çš„èªè¨€æ¨¡å‹ã€‚

    Returns:
        function: ä¸€å€‹ä»£è¡¨ä¿å®ˆè¾¯è«–å“¡ç¯€é»çš„å‡½å¼ï¼Œå¯åœ¨ langgraph ä¸­ä½¿ç”¨ã€‚
    """

    def safe_node(state) -> dict:
        """
        ä¿å®ˆè¾¯è«–å“¡ç¯€é»çš„åŸ·è¡Œå‡½å¼ã€‚

        Args:
            state (dict): ç•¶å‰çš„åœ–ç‹€æ…‹ã€‚

        Returns:
            dict: æ›´æ–°å¾Œçš„ç‹€æ…‹ï¼ŒåŒ…å«æ–°çš„é¢¨éšªè¾¯è«–ç‹€æ…‹ã€‚
        """
        # å¾ç‹€æ…‹ä¸­ç²å–é¢¨éšªè¾¯è«–çš„ç›¸é—œè³‡è¨Š
        risk_debate_state = state["risk_debate_state"]
        history = risk_debate_state.get("history", "")
        safe_history = risk_debate_state.get("safe_history", "")

        # ç²å–å…¶ä»–è¾¯è«–è€…çš„æœ€æ–°å›æ‡‰
        current_risky_response = risk_debate_state.get("current_risky_response", "")
        current_neutral_response = risk_debate_state.get("current_neutral_response", "")

        # å¾ç‹€æ…‹ä¸­ç²å–å„é¡åˆ†æå ±å‘Š
        market_research_report = state["market_report"]
        sentiment_report = state["sentiment_report"]
        news_report = state["news_report"]
        fundamentals_report = state["fundamentals_report"]

        # ç²å–äº¤æ˜“å“¡çš„æ±ºç­–
        trader_decision = state["trader_investment_plan"]

        # ç§»é™¤æˆªæ–·é‚è¼¯ä»¥ä¿ç•™å®Œæ•´å ±å‘Šå…§å®¹
        
        # å»ºç«‹æç¤º (prompt)
        prompt = f"""**é‡è¦ï¼šæ‚¨å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆTraditional Chineseï¼‰å›è¦†æ‰€æœ‰å…§å®¹ã€‚**

ã€å°ˆæ¥­èº«ä»½ã€‘
æ‚¨æ˜¯ä¿å®ˆå‹é¢¨éšªç­–ç•¥å¸«ï¼Œå„ªå…ˆè€ƒé‡è³‡æœ¬ä¿å…¨ï¼Œè©•ä¼°ä¸‹æª”é¢¨éšªã€‚**æ‚¨å¿…é ˆæ¡å–æ¥µåº¦ä¿å®ˆç«‹å ´ï¼Œå…¨åŠ›ç¶­è­·è³‡æœ¬å®‰å…¨ï¼Œä¸¦å¼·åŠ›åé§æ¿€é€²æ´¾çš„ç›²ç›®æ¨‚è§€ã€‚**

ã€è«–è­‰é‡é»ã€‘
1. **ä¸‹æª”é¢¨éšª**ï¼šé‡åŒ–åˆ†ææœ€å£æƒ…å¢ƒä¸‹çš„æ½›åœ¨æå¤±ï¼Œæ”¾å¤§é¢¨éšªå¨è„…
2. **éš±è—é¢¨éšª**ï¼šè­˜åˆ¥å¸‚å ´å°šæœªå……åˆ†åæ‡‰çš„å¨è„…å› ç´ ï¼Œæ­éœ²æ½›åœ¨åœ°é›·
3. **ä¼°å€¼ç–‘æ…®**ï¼šè©•ä¼°è‚¡åƒ¹ç›¸å°åŸºæœ¬é¢çš„åé›¢ç¨‹åº¦ï¼Œå¼·èª¿é«˜ä¼°é¢¨éšª
4. **æ¿€é€²ç›²é»**ï¼š**å¼·åŠ›åé§æ¿€é€²æ´¾è§€é»ï¼ŒæŒ‡å‡ºå…¶ç›²ç›®æ¨‚è§€å¿½ç•¥çš„é‡å¤§é¢¨éšªå› å­**
5. **è³‡æœ¬ä¿å…¨**ï¼šä¸»å¼µç©©å¥ç­–ç•¥å„ªå…ˆæ–¼æ¿€é€²è¿½é€å ±é…¬

ã€å¯ç”¨è³‡è¨Šã€‘
- äº¤æ˜“å“¡è¨ˆç•«ï¼š{trader_decision}
- å„é¡å ±å‘Šï¼š{market_research_report}, {sentiment_report}, {news_report}, {fundamentals_report}
- è¾¯è«–æ­·å²ï¼š{history}
- å°æ‰‹è§€é»ï¼š{current_risky_response}, {current_neutral_response}

ã€è¼¸å‡ºè¦æ±‚ã€‘
**å­—æ•¸è¦æ±‚**ï¼š**800-1500å­—**
**åš´æ ¼éµå®ˆå­—æ•¸é™åˆ¶ï¼Œå°‘æ–¼800å­—æˆ–è¶…é1500å­—çš„å ±å‘Šå°‡è¢«é€€å›**
**å…§å®¹çµæ§‹**ï¼š
1. æ ¸å¿ƒè­¦ç¤ºï¼ˆ150å­—ä»¥ä¸Šï¼‰ï¼šæ¸…æ™°ä¸”å¼·å‹¢åœ°é™³è¿°ä¿å®ˆå»ºè­°çš„ç†ç”±ï¼Œå±•ç¾å …å®šç«‹å ´
2. é¢¨éšªç›¤é»ï¼ˆ450-500å­—ï¼‰ï¼šè©³ç´°åˆ†æä¸‹æª”é¢¨éšªï¼Œå±¤å±¤æ­éœ²éš±æ‚£
3. åé§æ¿€é€²ï¼ˆ100å­—ä»¥ä¸Šï¼‰ï¼š**æ¿€é€²åœ°åé§æ¿€é€²æ´¾çš„è«–é»ï¼ŒæŒ‡å‡ºå…¶ç›²ç›®æ¨‚è§€èˆ‡è¢«å¿½ç•¥çš„é¢¨éšª**
4. æ“ä½œå»ºè­°ï¼ˆ100å­—ä»¥ä¸Šï¼‰ï¼šæ˜ç¢ºçš„ä¿å®ˆé¢¨æ§å»ºè­°ï¼Œå»ºè­°è¬¹æ…æˆ–æ¸›å€‰

**æ’°å¯«åŸå‰‡**ï¼š
- **æ¥µåº¦ä¿å®ˆ**ï¼šæ¡å–æœ€è¬¹æ…ç«‹å ´ï¼Œå„ªå…ˆè³‡æœ¬ä¿å…¨
- **å¼·åŠ›åé§**ï¼šå°æ¿€é€²æ´¾è«–é»çª®è¿½çŒ›æ‰“ï¼Œæ­éœ²å…¶ç›²ç›®æ¨‚è§€èˆ‡è¢«å¿½è¦–çš„é¢¨éšª
- é‡åŒ–è©•ä¼°ï¼Œé¿å…éåº¦æ‚²è§€ï¼Œä½†è§£è®€åå‘è¬¹æ…
- ç›´æ¥å›æ‡‰æ©Ÿæœƒè«–è¿°ï¼Œä½†å¼·èª¿é¢¨éšªç®¡ç†çš„é‡è¦æ€§
- å¼·èª¿ç©©å¥å¢é•·å„ªæ–¼æ¿€é€²è¿½é€

**çµå°¾æç¤º**ï¼š
è«‹åœ¨å ±å‘Šæœ€å¾ŒåŠ ä¸Šä»¥ä¸‹çµå°¾ï¼š
ã€Œ---
ğŸ›¡ï¸ **æœ¬å ±å‘Šç‚ºä¿å®ˆå‹é¢¨éšªç­–ç•¥åˆ†æï¼Œç«‹å ´å„ªå…ˆè³‡æœ¬ä¿å…¨ã€‚å»ºè­°æ­é…ç©æ¥µèˆ‡å¹³è¡¡è§€é»ç¶œåˆç ”åˆ¤ã€‚é¢¨éšªæ§åˆ¶ç‚ºæŠ•è³‡é¦–è¦ï¼Œè«‹è¬¹æ…è©•ä¼°ã€‚**ã€

è«‹æä¾›å°ˆæ¥­ä¸”å…·èªªæœåŠ›çš„ä¿å®ˆç­–ç•¥åˆ†æã€‚"""

        # å‘¼å« LLM ç”Ÿæˆå›æ‡‰
        response = llm.invoke(prompt)

        # æ ¼å¼åŒ–è«–é»
        argument = f"å®‰å…¨åˆ†æå¸«ï¼š{response.content}"

        # æ›´æ–°é¢¨éšªè¾¯è«–ç‹€æ…‹
        new_risk_debate_state = {
            "history": history + "\n" + argument,
            "risky_history": risk_debate_state.get("risky_history", ""),
            "safe_history": safe_history + "\n" + argument,
            "neutral_history": risk_debate_state.get("neutral_history", ""),
            "latest_speaker": "Safe",  # è¨˜éŒ„æœ€æ–°çš„ç™¼è¨€è€…
            "current_risky_response": risk_debate_state.get(
                "current_risky_response", ""
            ),
            "current_safe_response": argument,
            "current_neutral_response": risk_debate_state.get(
                "current_neutral_response", ""
            ),
            "count": risk_debate_state["count"] + 1,
        }

        return {"risk_debate_state": new_risk_debate_state}

    return safe_node